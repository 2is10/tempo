<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>
		Tempo | Solr
	</title>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
	<script type="text/javascript" src="../tempo.js"></script>
	<script type="text/javascript" src="js/solr.js"></script>
	<script type="text/javascript">

		var solrjs = new SolrJS();
		var responseTemplate, facetsTemplate;

		$(document).ready(function() {
			solrjs.query.host('http://twigkit.com/data/gutenberg/select/?version=2.2&start=0&rows=10&wt=json&facet=true&facet.limit=10&facet.field=subject&facet.field=language&facet.mincount=1');
			
			// Prepare templates
			breadcrumbsTemplate = Tempo.prepare('solr-breadcrumbs');
			responseTemplate = Tempo.prepare('solr-response');
			facetsTemplate = Tempo.prepare('solr-facets');
			
			// Default query
			search();
		});

		function search(q) {
			// Search request
			solrjs.query.query(q != undefined && q != '' ? q : 'literature');
			_request();
		}
		
		function addFilter(field, value) {
			solrjs.query.add_filter(field, value);
			_request();
		}
		
		function removeFilter(field, value) {
			solrjs.query.remove_filter(field, value);
			_request();
		}
		
		function _request() {
			$.ajax({
				url: solrjs.query.url(),
				dataType: 'jsonp',
				jsonp: 'json.wrf',
				success: function(data) {
					// Render the query breadcrumbs
					breadcrumbsTemplate.render(solrjs.query.filters);
					// Render the primary response and associated results
					responseTemplate.render(data.response);
					// Render the facets, using SolrJS function to improve the object structure first
					facetsTemplate.render(new SolrJS().response.getFacetsAsArray(data.facet_counts.facet_fields));
				}
			});
		}
	</script>
</head>
<body>
<h1>
	Tempo + Solr = True Love
</h1>

<form id="search" onsubmit="search($('#query').val()); return false;">
	<input type="text" name="query" id="query">
	<input type="submit" value="Search">
</form>

<ul id="solr-breadcrumbs">
	<li data-template><a href="#" onclick='removeFilter("{{field}}", "{{value}}");'>{{field}}:{{value}}</a></li>
</ul>

<div id="solr-response">
	<div data-template style="display: none;">
		Results found <span>{{numFound}}</span>

		<ol>
			<li data-template="docs">
				<span>{{title}}</span> by <span style="font-weight: bold;">{{creator}}</span>
			</li>
		</ol>
	</div>
</div>

<div id="solr-facets">
	<div>
		<ul>
			<li data-template style="display: none;">
				{{name}}
				<ul>
					<li data-template="facet">
						<a href="#" onclick='addFilter("{{field}}", "{{label}}");'>{{label}}</a> {{count}}
					</li>
				</ul>
			</li>
		</ul>
	</div>
</div>
</body>
</html>
